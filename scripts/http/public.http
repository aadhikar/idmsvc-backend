@schema = http
@hostname = localhost
@port = 8000
@host = {{hostname}}:{{port}}
@contentType = application/json
@createdAt = {{$datetime iso8601}}
@modifiedBy = {{$processEnv USERNAME}}
@x-rh-identity = eyJpZGVudGl0eSI6eyJhY2NvdW50X251bWJlciI6IjExMTExIiwiZW1wbG95ZWVfYWNjb3VudF9udW1iZXIiOiIyMjIyMiIsIm9yZ19pZCI6IjEyMzQ1IiwiaW50ZXJuYWwiOnsib3JnX2lkIjoiMTIzNDUifSwidXNlciI6eyJ1c2VybmFtZSI6Impkb2UiLCJlbWFpbCI6Impkb2VAZXhhbXBsZS5jb20iLCJmaXJzdF9uYW1lIjoiSm9obiIsImxhc3RfbmFtZSI6IkRvZSIsImlzX2FjdGl2ZSI6dHJ1ZSwiaXNfb3JnX2FkbWluIjp0cnVlLCJpc19pbnRlcm5hbCI6dHJ1ZSwibG9jYWxlIjoiZW4iLCJ1c2VyX2lkIjoiMTk4NzM0OCJ9LCJzeXN0ZW0iOnt9LCJhc3NvY2lhdGUiOnsiUm9sZSI6bnVsbCwiZW1haWwiOiIiLCJnaXZlbk5hbWUiOiIiLCJyaGF0VVVJRCI6IiIsInN1cm5hbWUiOiIifSwieDUwOSI6eyJzdWJqZWN0X2RuIjoiIiwiaXNzdWVyX2RuIjoiIn0sInR5cGUiOiJVc2VyIiwiYXV0aF90eXBlIjoiIn19Cg==
@x-rh-identity-system = ewogICJpZGVudGl0eSI6IHsKICAgICJhY2NvdW50X251bWJlciI6ICIxMTExMSIsCiAgICAiYXV0aF90eXBlIjogImNlcnQtYXV0aCIsCiAgICAiaW50ZXJuYWwiOiB7CiAgICAgICJhdXRoX3RpbWUiOiA5MDAsCiAgICAgICJjcm9zc19hY2Nlc3MiOiBmYWxzZSwKICAgICAgIm9yZ19pZCI6ICIxMjM0NSIKICAgIH0sCiAgICAib3JnX2lkIjogIjEyMzQ1IiwKICAgICJzeXN0ZW0iOiB7CiAgICAgICJjZXJ0X3R5cGUiOiAic3lzdGVtIiwKICAgICAgImNuIjogIjZmMzI0MTE2LWIzZDItMTFlZC04YTM3LTQ4MmFlMzg2M2QzMCIKICAgIH0sCiAgICAidHlwZSI6ICJTeXN0ZW0iCiAgfSwKICAiZW50aXRsZW1lbnRzIjogewogICAgImFuc2libGUiOiB7CiAgICAgICJpc19lbnRpdGxlZCI6IHRydWUsCiAgICAgICJpc190cmlhbCI6IGZhbHNlCiAgICB9LAogICAgImNvc3RfbWFuYWdlbWVudCI6IHsKICAgICAgImlzX2VudGl0bGVkIjogdHJ1ZSwKICAgICAgImlzX3RyaWFsIjogZmFsc2UKICAgIH0sCiAgICAiaW5zaWdodHMiOiB7CiAgICAgICJpc19lbnRpdGxlZCI6IHRydWUsCiAgICAgICJpc190cmlhbCI6IGZhbHNlCiAgICB9LAogICAgImludGVybmFsIjogewogICAgICAiaXNfZW50aXRsZWQiOiBmYWxzZSwKICAgICAgImlzX3RyaWFsIjogZmFsc2UKICAgIH0sCiAgICAibWlncmF0aW9ucyI6IHsKICAgICAgImlzX2VudGl0bGVkIjogdHJ1ZSwKICAgICAgImlzX3RyaWFsIjogZmFsc2UKICAgIH0sCiAgICAib3BlbnNoaWZ0IjogewogICAgICAiaXNfZW50aXRsZWQiOiB0cnVlLAogICAgICAiaXNfdHJpYWwiOiBmYWxzZQogICAgfSwKICAgICJyaGVsIjogewogICAgICAiaXNfZW50aXRsZWQiOiB0cnVlLAogICAgICAiaXNfdHJpYWwiOiBmYWxzZQogICAgfSwKICAgICJyaG9hbSI6IHsKICAgICAgImlzX2VudGl0bGVkIjogZmFsc2UsCiAgICAgICJpc190cmlhbCI6IGZhbHNlCiAgICB9LAogICAgInJob2RzIjogewogICAgICAiaXNfZW50aXRsZWQiOiBmYWxzZSwKICAgICAgImlzX3RyaWFsIjogZmFsc2UKICAgIH0sCiAgICAicmhvc2FrIjogewogICAgICAiaXNfZW50aXRsZWQiOiBmYWxzZSwKICAgICAgImlzX3RyaWFsIjogZmFsc2UKICAgIH0sCiAgICAic2V0dGluZ3MiOiB7CiAgICAgICJpc19lbnRpdGxlZCI6IHRydWUsCiAgICAgICJpc190cmlhbCI6IGZhbHNlCiAgICB9LAogICAgInNtYXJ0X21hbmFnZW1lbnQiOiB7CiAgICAgICJpc19lbnRpdGxlZCI6IHRydWUsCiAgICAgICJpc190cmlhbCI6IGZhbHNlCiAgICB9LAogICAgInN1YnNjcmlwdGlvbnMiOiB7CiAgICAgICJpc19lbnRpdGxlZCI6IHRydWUsCiAgICAgICJpc190cmlhbCI6IGZhbHNlCiAgICB9LAogICAgInVzZXJfcHJlZmVyZW5jZXMiOiB7CiAgICAgICJpc19lbnRpdGxlZCI6IHRydWUsCiAgICAgICJpc190cmlhbCI6IGZhbHNlCiAgICB9CiAgfQp9Cg==
@x-rh-idm-registration-token = OTU0YTBiYWUtYmYyNi0xMWVkLWE1Y2EtNDgyYWUzODYzZDMwCg==
@basepath = /api/hmsidm/v1
@fqdn = host1.domain.example
@subscription_manager_id = 6f324116-b3d2-11ed-8a37-482ae3863d30
@domain_uuid = b93b186b-8fd8-4978-a241-2ab0c3734136
# X-Rh-IDM-Version = base64 <<< '{"ipa-hcc": "0.7", "ipa": "4.10.0-8.el9_1"}' 
@x-rh-idm-version = eyJpcGEtaGNjIjogIjAuNyIsICJpcGEiOiAiNC4xMC4wLTguZWw5XzEifQo=

###

# @name createDomain

# Request for ephemeral
# curl -u "$CREDS" "${BASE_URL}/domains" -X POST -H "Content-Type: application/json" -d @./test/data/create-domain-ipa-payload.json

POST {{schema}}://{{host}}{{basepath}}/domains
X-Rh-Identity: {{x-rh-identity}}
X-Rh-Insights-Request-Id: post_domains
Content-Type: {{contentType}}

{
  "domain_name": "mydomain.example",
  "title": "My Domain Example",
  "description": "My human readable domain description",
  "domain_type": "ipa",
  "auto_enrollment_enabled": true,
  "ipa": {
    "realm_name": "MYDOMAIN.EXAMPLE",
    "servers": [
      {
        "fqdn": "ipaserver.mydomain.example",
        "rhsm_id": "547ce70c-9eb5-4783-a619-086aa26f88e5",
        "ca_server": true,
        "hcc_enrollment_server": true,
        "hcc_update_server": true,
        "pkinit_server": true
      }
    ],
    "ca_certs": [
      {
        "nickname": "MYDOMAIN.EXAMPLE IPA CA",
        "issuer": "CN=Certificate Authority,O=MYDOMAIN.EXAMPLE",
        "subject": "CN=Certificate Authority,O=MYDOMAIN.EXAMPLE",
        "serial_number": "1",
        "not_valid_before": "2023-01-31T13:23:36Z",
        "not_valid_after": "2023-01-31T13:23:36Z",
        "pem": "-----BEGIN CERTIFICATE-----\nMII...\n-----END CERTIFICATE-----\n"
      }
    ],
    "realm_domains": [
      "mydomain.example"
    ]
  }
}


### Create with no certs nor servers nor realm_domains

# @name createDomain

POST {{schema}}://{{host}}{{basepath}}/domains
X-Rh-Identity: {{x-rh-identity}}
X-Rh-Insights-Request-Id: post_domains
Content-Type: {{contentType}}

{
  "domain_name": "mydomain.example",
  "domain_description": "My human readable domain description",
  "domain_type": "ipa",
  "auto_enrollment_enabled": true,
  "ipa": {
    "realm_name": "MYDOMAIN.EXAMPLE",
    "servers": [],
    "ca_certs": [],
    "realm_domains": []
  }
}


### Get All Domains

# @name listDomains

# Request for ephemeral
# curl -u "$CREDS" "${BASE_URL}/domains"

GET http://{{host}}{{basepath}}/domains?offset=0&limit=10
X-Rh-Identity: {{x-rh-identity}}
X-Rh-Insights-Request-Id: get_domains
Content-Type: {{contentType}}

### Get last created Todo

# @name getDomain

# Request for ephemeral
# curl -u "$CREDS" "${BASE_URL}/domains/${UUID}"

GET  http://{{host}}{{basepath}}/domains/{{createDomain.response.body.domain_uuid}}
X-Rh-Identity: {{x-rh-identity}}
X-Rh-Insights-Request-Id: get_domains_uuid
Content-Type: {{contentType}}


### Prepare Register IPA domain mock response - return match with last created domain_uuid

# See: https://www.mock-server.com/mock_server/getting_started.html#button_match_by_inline_openapi_yaml
# See: https://www.mock-server.com/mock_server/mockserver_ui.html
# Open UI by: xdg-open "http://localhost:8010/mockserver/dashboard"
PUT http://localhost:8010/mockserver/expectation
Content-Type: application/json; charset=urf-8

{
  "httpRequest": {
    "method": "GET",
    "path": "/api/inventory/v1/hosts"
  },
  "httpResponse": {
    "body": {
      "type": "JSON",
      "string": "{\"total\":1,\"count\":1,\"page\":1,\"per_page\":50,\"results\":[{\"insights_id\":\"ca5b5f40-d97a-425e-94ca-0f099295677d\",\"subscription_manager_id\":\"{{subscription_manager_id}}\",\"satellite_id\":null,\"bios_uuid\":\"3c89d5a1-7287-4856-a20e-b85337a1771a\",\"ip_addresses\":[\"10.0.169.222\"],\"fqdn\":\"ipaserver.mydomain.example\",\"mac_addresses\":[\"fa:16:3e:7b:5e:3a\",\"00:00:00:00:00:00\"],\"provider_id\":null,\"provider_type\":null,\"id\":\"93bb346a-4297-4952-9ec4-f53b3a5006c2\",\"account\":\"11474377\",\"org_id\":\"16768564\",\"display_name\":\"server.hmsidm-dev.test\",\"ansible_host\":null,\"facts\":[],\"reporter\":\"cloud-connector\",\"per_reporter_staleness\":{\"cloud-connector\":{\"check_in_succeeded\":true,\"stale_timestamp\":\"2023-03-16T10:54:40+00:00\",\"last_check_in\":\"2023-03-15T08:54:40.613575+00:00\"},\"puptoo\":{\"check_in_succeeded\":true,\"stale_timestamp\":\"2023-03-16T13:54:24.432198+00:00\",\"last_check_in\":\"2023-03-15T08:54:24.714327+00:00\"}},\"stale_timestamp\":\"2023-03-16T10:54:40+00:00\",\"stale_warning_timestamp\":\"2023-03-23T10:54:40+00:00\",\"culled_timestamp\":\"2023-03-30T10:54:40+00:00\",\"created\":\"2023-03-15T08:54:24.740431+00:00\",\"updated\":\"2023-03-15T08:55:14.950975+00:00\"}]}",
      "contentType": "{{contentType}}"
    }
  }
}

### Register IPA domain information

# @name registerIpaDomain

PUT http://{{host}}{{basepath}}/domains/{{createDomain.response.body.domain_uuid}}/ipa/register
X-Rh-Identity: {{x-rh-identity-system}}
X-Rh-IDM-Registration-Token: {{createDomain.response.body.ipa.token}}
X-Rh-Insights-Request-Id: put_domains_ipa_register
X-Rh-IDM-Version: {{x-rh-idm-version}}
Content-Type: {{contentType}}

{
  "servers": [
    {
      "fqdn": "ipaserver.mydomain.example",
      "rhsm_id": "547ce70c-9eb5-4783-a619-086aa26f88e5",
      "ca_server": true,
      "hcc_enrollment_server": true,
      "hcc_update_server": true,
      "pkinit_server": true
    }
  ],
  "ca_certs": [
    {
      "nickname": "MYDOMAIN.EXAMPLE IPA CA",
      "issuer": "CN=Certificate Authority,O=MYDOMAIN.EXAMPLE",
      "subject": "CN=Certificate Authority,O=MYDOMAIN.EXAMPLE",
      "serial_number": "1",
      "not_valid_before": "2023-01-31T13:23:36Z",
      "not_valid_after": "2023-01-31T13:23:36Z",
      "pem": "-----BEGIN CERTIFICATE-----\nMII...\n-----END CERTIFICATE-----\n"
    }
  ],
  "realm_domains": [
    "mydomain.example"
  ]
}

### Partial Update Todo

# PATCH http://{{host}}{{basepath}}/domains/{{createDomain.response.body.domain_uuid}}
# X-Rh-Identity: {{x-rh-identity}}
# Content-Type: {{contentType}}

# {
#     "title": "Patched Todo Title"
# }

### Update Domain

# PUT http://{{host}}{{basepath}}/domains/{{createDomain.response.body.domain_uuid}}
# X-Rh-Identity: {{x-rh-identity}}
# Content-Type: {{contentType}}

# {
#     "id": {{createDomain.response.body.domain_uuid}},
#     "title": "Updated Todo Title",
#     "body": "Updated body"
# }

### Delete Domain

DELETE http://{{host}}{{basepath}}/domains/{{createDomain.response.body.domain_uuid}}
X-Rh-Identity: {{x-rh-identity}}
X-Rh-Insights-Request-Id: delete_domains
Content-Type: {{contentType}}

### HostConf
POST http://{{host}}{{basepath}}/host-conf/{{fqdn}}
X-Rh-Identity: TODO Fill a test certificate value
X-Rh-Insights-Request-Id: post_host_conf
Content-Type: {{contentType}}


### CheckHost
POST http://{{host}}{{basepath}}/check-host/{{subscription_manager_id}}/{{fqdn}}
X-Rh-Identity: TODO Fill a test certificate value
X-Rh-Insights-Request-Id: post_check_host
Content-Type: {{contentType}}

